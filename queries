--Table creation SQL Queries

--USERS table 

CREATE TABLE Users (
    user_id NUMBER PRIMARY KEY,
    full_name VARCHAR2(100) NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    phone VARCHAR2(15),
    created_at DATE DEFAULT SYSDATE
);

--ACCOUNTS table
CREATE TABLE Accounts (
    account_id NUMBER PRIMARY KEY,
    user_id NUMBER REFERENCES Users(user_id),
    balance NUMBER(15, 2) DEFAULT 0,
    currency_code VARCHAR2(3),
    created_at DATE DEFAULT SYSDATE,
    FOREIGN KEY (currency_code) REFERENCES Currencies(currency_code)
);

--TRANSACTIONS table
CREATE TABLE Transactions (
    transaction_id NUMBER PRIMARY KEY,
    account_id NUMBER REFERENCES Accounts(account_id),
    transaction_type VARCHAR2(10), -- 'deposit', 'withdrawal'
    amount NUMBER(15, 2),
    transaction_date DATE DEFAULT SYSDATE,
    details VARCHAR2
);

--EXCHANGERATE table
CREATE TABLE ExchangeRates (
    rate_id NUMBER PRIMARY KEY,
    from_currency VARCHAR2(3),
    to_currency VARCHAR2(3),
    rate NUMBER(10, 4),
    updated_at DATE DEFAULT SYSDATE,
    FOREIGN KEY (from_currency) REFERENCES Currencies(currency_code),
    FOREIGN KEY (to_currency) REFERENCES Currencies(currency_code)
);

--CURRENCIES table 
CREATE TABLE Currencies (
    currency_code VARCHAR2(3) PRIMARY KEY,
    name VARCHAR2(50),
    symbol VARCHAR2(10)
);


--Package Creation

create or replace PACKAGE user_account_pkg AS
    -- Function to generate a summary string after creation
    FUNCTION create_user_with_account_fn(
        p_full_name     VARCHAR2,
        p_email         VARCHAR2,
        p_phone         VARCHAR2,
        p_currency_code VARCHAR2
    ) RETURN VARCHAR2;

    -- Procedure version (calls the function internally)
    PROCEDURE create_user_with_account_proc(
        p_full_name     VARCHAR2,
        p_email         VARCHAR2,
        p_phone         VARCHAR2,
        p_currency_code VARCHAR2
    );
END user_account_pkg;

--Package Body Creation
create or replace PACKAGE BODY user_account_pkg AS

    FUNCTION create_user_with_account_fn(
        p_full_name     VARCHAR2,
        p_email         VARCHAR2,
        p_phone         VARCHAR2,
        p_currency_code VARCHAR2
    ) RETURN VARCHAR2 IS
        v_user_id       USERS.USER_ID%TYPE;
        v_account_id    ACCOUNTS.ACCOUNT_ID%TYPE;
        v_msg           VARCHAR2(500);
    BEGIN
        -- Insert user
        INSERT INTO USERS (full_name, email, phone)
        VALUES (p_full_name, p_email, p_phone)
        RETURNING user_id INTO v_user_id;

        -- Insert account
        INSERT INTO ACCOUNTS (user_id, balance, currency_code)
        VALUES (v_user_id, 0, p_currency_code)
        RETURNING account_id INTO v_account_id;

        -- Success message
        v_msg := 'User created: ' || p_full_name ||
                 ', User ID: ' || v_user_id ||
                 ', Account ID: ' || v_account_id ||
                 ', Currency: ' || p_currency_code;

        RETURN v_msg;
    END create_user_with_account_fn;

    PROCEDURE create_user_with_account_proc(
        p_full_name     VARCHAR2,
        p_email         VARCHAR2,
        p_phone         VARCHAR2,
        p_currency_code VARCHAR2
    ) IS
        v_result VARCHAR2(500);
    BEGIN
        v_result := create_user_with_account_fn(
                        p_full_name, p_email, p_phone, p_currency_code);
        DBMS_OUTPUT.PUT_LINE(v_result);
    END create_user_with_account_proc;

END user_account_pkg;

--All Procedures Creation

--Deposit procedure
create or replace PROCEDURE deposit_money (
    p_account_id IN NUMBER,
    p_amount     IN NUMBER,
    p_details    IN VARCHAR2 DEFAULT NULL
) AS
    v_currency_code ACCOUNTS.currency_code%TYPE;
    v_transaction_date DATE := SYSDATE;
BEGIN

    set_change_type_proc('deposit');

    IF p_amount <= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Deposit amount must be greater than zero.');
    END IF;

    SELECT currency_code INTO v_currency_code FROM ACCOUNTS WHERE account_id = p_account_id;
    
    -- Update account balance
    UPDATE accounts
    SET balance = balance + p_amount
    WHERE account_id = p_account_id;

    -- Insert transaction
    INSERT INTO transactions (
        account_id, transaction_type, amount, details
    ) VALUES (
        p_account_id, 'deposit', p_amount, p_details
    );

    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('Deposit successful:');
    DBMS_OUTPUT.PUT_LINE('Account ID: ' || p_account_id || ', Amount: ' || p_amount || ' ' || v_currency_code);
    DBMS_OUTPUT.PUT_LINE('Date: ' || TO_CHAR(v_transaction_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Thank you for using PeerFlow !!!');
END;

--Withdraw procedure
create or replace PROCEDURE withdraw_money (
    p_account_id IN NUMBER,
    p_amount     IN NUMBER,
    p_details    IN VARCHAR2 DEFAULT NULL
) AS
    v_balance         ACCOUNTS.balance%TYPE;
    v_currency_code   ACCOUNTS.currency_code%TYPE;
    v_transaction_date DATE := SYSDATE;
BEGIN
    
    set_change_type_proc('withdrawal');
    
    IF p_amount <= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Withdrawal amount must be greater than zero.');
    END IF;

    -- Get balance and currency_code
    SELECT balance, currency_code INTO v_balance, v_currency_code FROM ACCOUNTS WHERE account_id = p_account_id;

    IF v_balance < p_amount THEN
        RAISE_APPLICATION_ERROR(-20002, 'Insufficient balance.');
    END IF;

    -- Update balance
    UPDATE accounts
    SET balance = balance - p_amount
    WHERE account_id = p_account_id;

    -- Log transaction
    INSERT INTO transactions (
        account_id, transaction_type, amount, details
    ) VALUES (
        p_account_id, 'withdrawal', p_amount, p_details
    );

    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('Withdrawal successful:');
    DBMS_OUTPUT.PUT_LINE('Account ID: ' || p_account_id || ', Amount: ' || p_amount || ' ' || v_currency_code);
    DBMS_OUTPUT.PUT_LINE('Date: ' || TO_CHAR(v_transaction_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Thank you for using PeerFlow !!!');
    
END;

--Transfer procedure
create or replace PROCEDURE transfer_money (
    p_sender_account_id   IN NUMBER,
    p_receiver_account_id IN NUMBER,
    p_amount              IN NUMBER,
    p_details    IN VARCHAR2 DEFAULT NULL
) AS
    v_sender_balance     ACCOUNTS.balance%TYPE;
    v_sender_currency    ACCOUNTS.currency_code%TYPE;
    v_receiver_currency  ACCOUNTS.currency_code%TYPE;
    v_exchange_rate      EXCHANGERATES.rate%TYPE := 1;
    v_converted_amount NUMBER;
    v_transaction_date   DATE := SYSDATE;
    v_sender_name        USERS.full_name%TYPE;
    v_receiver_name      USERS.full_name%TYPE;
BEGIN

    set_change_type_proc('transfer_out');
    set_change_type_proc('transfer_in');
    
    
    IF p_amount <= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Transfer amount must be greater than zero.');
    END IF;

    -- Get balances and currency codes
    SELECT a.balance, a.currency_code, u.full_name
    INTO v_sender_balance, v_sender_currency, v_sender_name
    FROM ACCOUNTS a JOIN USERS u ON a.user_id = u.user_id
    WHERE a.account_id = p_sender_account_id;

    SELECT a.currency_code, u.full_name
    INTO v_receiver_currency, v_receiver_name
    FROM ACCOUNTS a JOIN USERS u ON a.user_id = u.user_id
    WHERE a.account_id = p_receiver_account_id;

    -- Ensure sender has enough money
    IF v_sender_balance < p_amount THEN
        RAISE_APPLICATION_ERROR(-20002, 'Insufficient funds.');
    END IF;

    -- Get exchange rate if needed
    IF v_sender_currency != v_receiver_currency THEN
        SELECT rate INTO v_exchange_rate FROM EXCHANGERATES
        WHERE from_currency = v_sender_currency AND to_currency = v_receiver_currency;
    END IF;

    v_converted_amount := p_amount * v_exchange_rate;

    -- Deduct from sender
    UPDATE accounts
    SET balance = balance - p_amount
    WHERE account_id = p_sender_account_id;

    -- Credit receiver
    UPDATE accounts
    SET balance = balance + v_converted_amount
    WHERE account_id = p_receiver_account_id;

    -- Log transactions
    INSERT INTO transactions (
        account_id, transaction_type, amount, details
    ) VALUES (
        p_sender_account_id, 'transfer_out', p_amount, p_details
    );

    INSERT INTO transactions (
        account_id, transaction_type, amount, details
    ) VALUES (
        p_receiver_account_id, 'transfer_in', v_converted_amount, p_details
    );

    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('Transfer successful:');
    DBMS_OUTPUT.PUT_LINE('Sender: ' || v_sender_name || ', Sent: ' || p_amount || ' ' || v_sender_currency);
    DBMS_OUTPUT.PUT_LINE('Receiver: ' || v_receiver_name || ', Received: ' || v_converted_amount || ' ' || v_receiver_currency);
    DBMS_OUTPUT.PUT_LINE('Date: ' || TO_CHAR(v_transaction_date, 'YYYY-MM-DD'));
    DBMS_OUTPUT.PUT_LINE('Thank you for using PeerFlow !!!');
END;

--User Profile procedure
create or replace PROCEDURE show_user_profile(p_user_id IN NUMBER) IS
    v_full_name      USERS.full_name%TYPE;
    v_email          USERS.email%TYPE;
    v_phone          USERS.phone%TYPE;
    v_account_id     ACCOUNTS.account_id%TYPE;
    v_balance        ACCOUNTS.balance%TYPE;
    v_currency_code  ACCOUNTS.currency_code%TYPE;
BEGIN
    -- Fetch user and their account info
    SELECT u.full_name, u.email, u.phone, a.account_id, a.balance, a.currency_code
    INTO v_full_name, v_email, v_phone, v_account_id, v_balance, v_currency_code
    FROM USERS u
    JOIN ACCOUNTS a ON u.user_id = a.user_id
    WHERE u.user_id = p_user_id;

    -- Display user profile info
    DBMS_OUTPUT.PUT_LINE('--- USER PROFILE ---');
    DBMS_OUTPUT.PUT_LINE('Name      : ' || v_full_name);
    DBMS_OUTPUT.PUT_LINE('Email     : ' || v_email);
    DBMS_OUTPUT.PUT_LINE('Phone     : ' || v_phone);
    DBMS_OUTPUT.PUT_LINE('Account ID: ' || v_account_id);
    DBMS_OUTPUT.PUT_LINE('Balance   : ' || v_balance || ' ' || v_currency_code);
    DBMS_OUTPUT.PUT_LINE('    ');
    DBMS_OUTPUT.PUT_LINE('----------- TRANSACTIONS HISTORY -----------');

    -- Loop through transactions and include currency from account table
    FOR rec IN (
        SELECT t.transaction_type, t.amount, a.currency_code, t.transaction_date, t.details
        FROM TRANSACTIONS t
        JOIN ACCOUNTS a ON t.account_id = a.account_id
        WHERE a.user_id = p_user_id
        ORDER BY t.transaction_date DESC
    ) LOOP
        DBMS_OUTPUT.PUT_LINE('[' || rec.transaction_date || '] ' ||
                             rec.transaction_type || ': ' ||
                             rec.amount || ' ' || rec.currency_code ||
                             ' - ' || rec.details);
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('---------- END ------------');
    DBMS_OUTPUT.PUT_LINE('    ');
    DBMS_OUTPUT.PUT_LINE('Thank you for using PeerFlow!');
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No user or account found for the provided user ID.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;

--Trigger
create or replace TRIGGER trg_log_account_changes
AFTER UPDATE OF balance ON ACCOUNTS
FOR EACH ROW
BEGIN
    INSERT INTO ACCOUNTS_LOG (
        account_id,
        old_balance,
        new_balance,
        change_type,
        changed_at
    ) VALUES (
        :OLD.account_id,
        :OLD.balance,
        :NEW.balance,
        SYS_CONTEXT('peerflow_ctx', 'change_type'),
        SYSTIMESTAMP
    );
END;
